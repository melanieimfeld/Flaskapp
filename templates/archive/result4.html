<!DOCTYPE html>
<html lang="en">
<head>
  <title>Networkviz</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <script src="http://d3js.org/d3.v4.min.js"></script>
</head>
<style type="text/css">
  #viz {
    position:absolute;
  }

body {

  font-family: 'Roboto', sans-serif;
}
.axis { 
  font: 9px sans-serif; 
  text-anchor: start;
  color: "gray";
  }

line {
    stroke: #777;
    stroke-width: 1px;
}

circle {
  fill: cadetblue;
  opacity:0.6;
  z-index:99;
  stroke: "Pink";
}
</style>
<body>

<div class="page-header">
  <h1>BGER Visualisation</h1>
</div>
  
<div class="container-fluid">
  <form action = "http://localhost:5000/result" method = "POST">
         <p>Keyword <input type = "text" name = "Name" /></p>
         <p><input type = "submit" value = "submit" /></p>
  </form>
  <div class="row">
    <div class="col-lg-6 col-md-6 ml-3">
      <h3>Mandate text</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit...</p>
      <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris...</p>
    </div>
    <div class="col-lg-6 col-md-6">
      <h3>Visualisation</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit...</p>
      <div id="viz">
        <svg></svg>
      </div>
    </div>
  </div>
</div>

</body>
<script>
var data2 = {
  'nodes': 
    [{"id": "BGE 95 IV 162", "x":"1969-12-5", "y":208.992345},
    {"id": "BGE 80 IV 238", "x":"1969-9-4", "y":208.992345},
    {"id": "BGE 80 IV 240", "x":"1961-9-4", "y":208.992345},
    {"id": "BGE 82 IV 8", "x":"1960-1-3", "y":308.992345}],
  'links': 
    [{"source":'BGE 95 IV 162', "target":'BGE 80 IV 238'},
    {"source":'BGE 95 IV 162', "target":'BGE 80 IV 240'},
    {"source":'BGE 95 IV 162', "target":'BGE 82 IV 8'}]
}


var data3 = {
  'nodes': 
    [{"id": "BGE 95 IV 162", "date":"1969-12-5", "relevancy":10},
    {"id": "BGE 80 IV 238", "date":"1969-9-4", "relevancy":9},
    {"id": "BGE 80 IV 240", "date":"1961-9-4", "relevancy":7},
    {"id": "BGE 82 IV 8", "date":"1960-1-3", "relevancy":4}],
  'links': 
    [{"source":0, "target":1},
    {"source":0, "target":2},
    {"source":0, "target":3}]
}
//https://bl.ocks.org/rsk2327/2ebd7f00d43b492e64eee14f35babeac

// var nodes_data = [
//     {"id": "BGE 95 IV 162", "date":"1969-12-5", "relevancy":10},
//     {"id": "BGE 80 IV 238", "date":"1969-9-4", "relevancy":9},
//     {"id": "BGE 80 IV 240", "date":"1961-9-4", "relevancy":7},
//     {"id": "BGE 82 IV 8", "date":"1960-1-3", "relevancy":4}
// ]

// var links_data = [
//     {"source":0, "target":1},
//     {"source":0, "target":2},
//     {"source":0, "target":3}
// ]

//extract nodes and links
var nodes = data3.nodes,
    links = data3.links;

//console.log("test", links_data);

var margin = {top: 20, right: 20, bottom: 30, left: 30},
    width = 600 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

//--------------------transforming dates in positions---------------
//The format in the CSV, which d3 will read
var parseDate = d3.timeParse("%Y-%m-%d");
console.log(parseDate(data2["nodes"][3].x))
// Object.keys(data["nodes"]).forEach(function(key, index) {
//     console.log(key, index, data["nodes"][index].x);
//     test = parseDate.parse(data["nodes"][index].x);
//     console.log("date", test);
// });
var startDate = new Date();
var x  = d3.scaleTime()
  .domain([new Date(1959, 0, 1), new Date(1971, 0, 2)]) //still needs to be made dynamically
  .range([margin.left, width]); //range of x axis will be 1000px

var xPos = x(parseDate(data2["nodes"][0].x));
var xPos2 = x(parseDate(data2["nodes"][3].x));
console.log('timeparse positions', xPos, xPos2, startDate);

//--------------------x-axis---------------
//https://stackoverflow.com/questions/49785479/force-layout-dragging-objects-are-far-away-from-the-correct-position
var svg = d3.select('svg')
    .attr('width', width + margin.left + margin.right) //size including margin
    .attr('height', height + margin.top + margin.bottom);

  // Add the x Axis
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .attr("class", "axis")
      .call(d3.axisBottom(x)
        .tickFormat(d3.timeFormat("%Y-%m-%d")))
      .selectAll("text")
        .attr("transform", "rotate(45)")

  // text LABEL for the x axis
  svg.append("text")             
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (height-10) + ")")
      .style("text-anchor", "middle")
      .text("Date of Mandate");


//-------------------y-axis----------------
var array = Object.values(nodes); //transform object to array
var y = d3.scaleLinear()
  .domain([0,d3.max(array, function(d) {
    return d.relevancy})]) //set max domain dynamically
  .range([height,margin.top])


  // Add the y Axis
  svg.append("g")
      .attr("transform", "translate(" + margin.left + ",0)")
      .attr("class", "axis")
      .call(d3.axisLeft(y)
        .ticks(10)
        );

  // text LABEL for the y axis
  svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y",margin.left+10)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Relevancy");   


//--------------------network graph---------------
//set up the simulation 
//nodes only for now 
var simulation = d3.forceSimulation()
          //add nodes
          .nodes(nodes); 
                    
//add forces
//we're going to add a charge to each node 
//also going to add a centering force
simulation
    .force("charge_force", d3.forceManyBody())
    .force("center_force", d3.forceCenter(width / 2, height / 2));


//draw circles for the nodes 
var node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter()
        .append("circle")
        .attr('r', 20)
    

var text = node.append("text")
    .attr("dx", 2)
    .attr("dy", 2)
    .text(function(d) { return d.id; })
//add tick instructions: 
simulation.on("tick", tickActions);



var link_force =  d3.forceLink(links)

//Add a links force to the simulation
//Specify links  in d3.forceLink argument   


simulation.force("links",link_force)

//draw lines for the links 
var link = svg.append("g")
    .selectAll("line")
    .data(links)
    .enter().append("line")
      .attr("stroke-width", 2);   


var label = svg.append("g")
      .attr("class", "labels")
      .selectAll("text")
      .data(nodes)
      .enter().append("text")
        .attr("class", "label")
        .text(function(d) { return d.id; });     
                
                
function tickActions() {
    //update circle positions each tick of the simulation 
    node
        .attr("cx", function(d) { 
          //console.log("date", d.date)
          return x(parseDate(d.date)); })
        .attr("cy", function(d) { 
          //console.log(d.relevancy)
          return y(d.relevancy); });
    
    //update link positions 
    //simply tells one end of the line to follow one node around
    //and the other end of the line to follow the other node around
    link
        .attr("x1", function(d) { 
          return x(parseDate(d.source.date)); })
        .attr("y1", function(d) { return y(d.source.relevancy); })
        .attr("x2", function(d) { return x(parseDate(d.target.date)); })
        .attr("y2", function(d) { return y(d.target.relevancy); });


      label
        .attr("x", function(d) { return x(parseDate(d.date)); })
            .attr("y", function (d) { return y(d.relevancy); })

  }
    

</script>

</html>
